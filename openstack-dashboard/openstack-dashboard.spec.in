Summary: OpenStack Dashboard
Name: openstack-dashboard
Version: @DASHBOARD_VERSION@
Release: @BUILD_NUMBER@
License: ASL 2.0
Vendor: OpenStack, repackaged by Citrix Systems, Inc.
Group: Applications/System
URL: https://launchpad.net/openstack-dashboard
Source0: openstack-dashboard-%{version}-%{release}.tar.gz
Source1: local_settings.py
Source2: wsgi.py
Source10: openstack-dashboard
Source12: openstack-dashboard.sh
Source13: openstack-dashboard.logrotate
Source14: openstack-dashboard.init

BuildArch: noarch
BuildRoot: %{_tmppath}/%{name}

Requires(post): chkconfig
Requires(preun): chkconfig

%global _sharedstatedir /var/lib
%global python_sitelib /usr/lib/python2.6/site-packages

%description

%prep
%setup -q -n openstack-dashboard-%{version}

%build
set -eu
cd django-openstack
%{__python} setup.py build
cd ..
cd openstack-dashboard
%{__python} setup.py build
cd ..

%install
set -eu
rm -rf %{buildroot}

cd django-openstack
%{__python} setup.py install -O1 --root %{buildroot}

cd ../openstack-dashboard
%{__python} setup.py install -O1 --root %{buildroot}
cd ..

install -m 644 %{SOURCE2} %{buildroot}%{python_sitelib}/dashboard/wsgi.py

# Set up /etc/dashboard/ and link for local_settings.py.
install -p -D -m 644 %{SOURCE1} %{buildroot}%{_sysconfdir}/dashboard/local_settings.py
rm -f %{buildroot}%{python_sitelib}/local/local_settings.py*
ln -s %{_sysconfdir}/dashboard/local_settings.py %{buildroot}%{python_sitelib}/local/local_settings.py

# Setup directories
install -d -m 755 %{buildroot}%{_sharedstatedir}/dashboard
install -d -m 755 %{buildroot}%{_sysconfdir}/dashboard
install -d -m 755 %{buildroot}%{_localstatedir}/log/dashboard

# Install init files
install -p -D -m 755 %{SOURCE14} %{buildroot}%{_initrddir}/openstack-dashboard
install -p -D -m 755 %{SOURCE12} %{buildroot}%{_initrddir}/openstack-dashboard.sh

# Install bin file
install -p -D -m 755 %{SOURCE10} %{buildroot}%{_bindir}/openstack-dashboard

# Install logrotate
install -p -D -m 644 %{SOURCE13} %{buildroot}%{_sysconfdir}/logrotate.d/openstack-dashboard

# Install pid directory
install -d -m 755 %{buildroot}%{_localstatedir}/run/dashboard

# Install CloudStack media files
install -d -m 755 %{buildroot}%{python_sitelib}/media
mv dashboard-cs %{buildroot}%{python_sitelib}/media

%clean

%post
set -eu
/sbin/chkconfig --add openstack-dashboard

%preun
if [ $1 = 0 ] ; then
    /sbin/service openstack-dashboard stop >/dev/null 2>&1
    /sbin/chkconfig --del openstack-dashboard
fi

%files
%defattr(-,root,root,-)
%config(noreplace) %{_bindir}/openstack-dashboard
%config(noreplace) %{_sysconfdir}/dashboard
%{python_sitelib}/django_openstack
%{python_sitelib}/django_openstack-*.egg-info
%{python_sitelib}/local
%{python_sitelib}/dashboard
%{python_sitelib}/openstack_dashboard-%{version}-*.egg-info
%{python_sitelib}/media/dashboard-cs
%config(noreplace) %{_sysconfdir}/logrotate.d/openstack-dashboard
%config(noreplace) %{_initrddir}/openstack-dashboard
%config(noreplace) %{_initrddir}/openstack-dashboard.sh
%dir %attr(0755, root, root) %{_localstatedir}/log/dashboard
%dir %attr(0755, root, root) %{_localstatedir}/run/dashboard
%{_sharedstatedir}/dashboard
